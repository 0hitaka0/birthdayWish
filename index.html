<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inezia‚Äôs Birthday Quest ‚Ä¢ Sweet & Salty</title>
<style>
  :root{
    --bg:#0b0f16; --panel:#121826; --fg:#f6fbff; --muted:#a9b8c9;
    --accent:#1e90ff; --accent-2:#72b7ff; --good:#66ffa8; --warn:#ffd447; --bad:#ff7a7a;
    --ring: 0 0 0 2px rgba(30,144,255,.25);
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 20%,#121826,var(--bg));color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{min-height:100%;display:grid;place-items:center;padding:16px}
  .card{width:min(760px,94vw);background:var(--panel);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.5),inset 0 0 0 1px rgba(255,255,255,.06);overflow:hidden}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:linear-gradient(180deg,rgba(255,255,255,.04),transparent)}
  .badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-weight:700;letter-spacing:.3px}
  .cta{display:flex;gap:8px}
  button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:800;letter-spacing:.3px;cursor:pointer;background:var(--accent);color:#081018;box-shadow:0 10px 22px rgba(30,144,255,.35)}
  button.secondary{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.16);box-shadow:none}
  main{padding:24px 18px 32px;display:grid;gap:20px}
  .screen{display:none}
  .screen.active{display:block}
  .title{font-size:clamp(22px,3.2vw,30px);margin:0 0 4px}
  .sub{opacity:.9;color:var(--muted);margin:0 0 12px}
  .panel{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}
  .center{display:grid;place-items:center;text-align:center}
  .stage{display:grid;gap:18px}
  .narrative{max-width:520px;margin:0 auto;text-align:center}

  /* TTT */
  .ttt{width:min(320px,80vw);aspect-ratio:1;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:0 auto}
  .ttt button{background:#0f1522;border:1px solid rgba(255,255,255,.12);color:var(--fg);font-size:38px;font-weight:900;border-radius:14px}
  .ttt button:focus{outline:none;box-shadow:var(--ring)}
  .ttt .win{background:linear-gradient(180deg,rgba(102,255,168,.18),transparent)}

  /* Sudoku 4x4 */
  .sudoku{display:grid;gap:10px}
  .grid4{display:grid;grid-template-columns:repeat(4,54px);gap:6px;justify-content:center}
  .grid4 input{width:54px;height:54px;text-align:center;font-size:24px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:#0f1522;color:var(--fg)}
  .grid4 input.block{background:#0c1220;border-color:rgba(255,255,255,.08)}
  .grid4 input:focus{outline:none;box-shadow:var(--ring)}
  .err{color:var(--bad);font-weight:700}
  .ok{color:var(--good);font-weight:700}

  /* Boss */
  .boss{display:grid;gap:12px;grid-template-columns:1fr;align-items:center}
  .croc{display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:center}
  .croc .face{width:120px;height:120px;border-radius:18px;background:linear-gradient(180deg,#2c8a3e,#1e5d2a);position:relative;border:1px solid rgba(255,255,255,.08)}
  .eye{position:absolute;top:28px;width:22px;height:22px;background:#fff;border-radius:50%}
  .eye.left{left:28px}.eye.right{right:28px}
  .pupil{position:absolute;top:6px;left:6px;width:10px;height:10px;background:#0b0f16;border-radius:50%}
  .teeth{position:absolute;bottom:6px;left:10px;right:10px;height:14px;display:flex;justify-content:space-between}
  .teeth span{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:10px solid #fff;filter:drop-shadow(0 1px 0 rgba(0,0,0,.2))}
  .speech{background:#0f1522;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:10px}
  .qte{display:flex;gap:8px;flex-wrap:wrap}
  .qte button{background:#0f1522;border:1px solid rgba(255,255,255,.16);color:var(--fg);box-shadow:none}
  .qte button.good{background:var(--good);color:#08331d}

  /* Gift */
  .gift{display:grid;place-items:center;gap:12px;padding:10px}
  .box{width:120px;height:90px;border-radius:12px;background:linear-gradient(180deg,var(--accent),var(--accent-2));position:relative}
  .box:before{content:"";position:absolute;left:50%;top:-18px;transform:translateX(-50%);width:84px;height:26px;background:linear-gradient(180deg,var(--accent-2),var(--accent));border-radius:12px 12px 0 0}
  .ribbon{position:absolute;left:50%;transform:translateX(-50%);top:-2px;width:14px;height:92px;background:#f7fbff;border-radius:6px}

  /* Popup */
  .popup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:24px;z-index:2000;}
  .popup.active{display:flex;}
  .popup-backdrop{position:absolute;inset:0;background:rgba(8,12,20,.78);backdrop-filter:blur(6px);}
  .popup-card{position:relative;max-width:360px;width:min(360px,90vw);text-align:center;z-index:1;}
  body.popup-open{overflow:hidden;}
</style>
</head>
<body>
  <audio id="bgm" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_74f76b0361.mp3?filename=balloons-rising-116861.mp3" preload="auto" loop></audio>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="badges">
          <span class="badge" id="lvl">Level 1</span>
          <span class="badge">Player: <b style="margin-left:6px">Inezia</b></span>
          <span class="badge">Chocolates: <b id="choc">0</b> üç´</span>
        </div>
        <div class="cta">
          <button id="restart" class="secondary">Restart</button>
        </div>
      </header>

      <main>
        <!-- Intro / narrative -->
        <section id="screen-intro" class="screen active">
          <div class="panel narrative">
            <h2 class="title">Sweet & Salty: Inezia‚Äôs Birthday Quest</h2>
            <p class="sub">Collect chocolates, pass each mission, and team up with Kia to defeat the Manipulative Crocodile. Ready? üíô</p>
            <div class="gift" style="margin:12px 0 18px">
              <div class="box"><span class="ribbon"></span></div>
              <p class="sub">A surprise awaits at the end‚Ä¶</p>
            </div>
            <button id="start">Start Adventure</button>
          </div>
        </section>

        <!-- Level 1: TicTacToe -->
        <section id="screen-ttt" class="screen">
          <div class="panel stage">
            <div class="center">
              <h3 class="title">Level 1 ¬∑ Tic Tac Toe</h3>
              <p class="sub">Beat the chatty Yapbot in a best-of-three to earn <b>5 chocolates</b>.</p>
            </div>
            <div id="tttBoard" class="ttt"></div>
            <p id="tttMsg" class="sub" style="text-align:center"></p>
            <div class="speech" id="yapLines">‚ÄúI‚Äôm not annoying, I‚Äôm just efficient at talking.‚Äù</div>
            <div class="cta" style="justify-content:center"><button id="tttReset" class="secondary">Reset Round</button></div>
          </div>
        </section>

        <!-- Level 2: Sudoku 4x4 -->
        <section id="screen-sudoku" class="screen">
          <div class="panel stage center">
            <h3 class="title">Level 2 ¬∑ Mini Sudoku (4√ó4)</h3>
            <p class="sub">Each row and column must contain the numbers <b>1‚Äì4</b>. Finish to earn <b>10 chocolates</b>.</p>
            <div class="sudoku">
              <div id="sGrid" class="grid4"></div>
              <div class="cta" style="justify-content:center">
                <button id="checkSudoku">Check</button>
                <button id="newSudoku" class="secondary">New Puzzle</button>
              </div>
              <p id="sMsg" class="sub"></p>
            </div>
            <p class="sub" style="max-width:420px;margin:0 auto">Blocked cells are clues Kia left for you. Keep focus‚Äîthe crocodile is waiting.</p>
          </div>
        </section>

        <!-- Level 3: Boss -->
        <section id="screen-boss" class="screen">
          <div class="panel boss">
            <h3 class="title">Final Boss ¬∑ Manipulative Crocodile üêä</h3>
            <div class="croc">
              <div class="face">
                <div class="eye left"><div class="pupil"></div></div>
                <div class="eye right"><div class="pupil"></div></div>
                <div class="teeth"><span></span><span></span><span></span><span></span></div>
              </div>
              <div>
                <div id="crocLine" class="speech">‚ÄúWhy share when you can keep all the chocolates for yourself?‚Äù</div>
                <p class="sub">Spend <b>10 chocolates</b> to summon <b>Kia</b> and block the manipulation. Then hit 3 quick blocks to win.</p>
                <div class="cta" style="flex-wrap:wrap">
                  <button id="payKia">Pay Kia 10 üç´</button>
                  <button id="block1" class="secondary" disabled>Block 1</button>
                  <button id="block2" class="secondary" disabled>Block 2</button>
                  <button id="block3" class="secondary" disabled>Block 3</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Ending -->
        <section id="screen-end" class="screen center">
          <div class="panel center">
            <h3 class="title">Victory! ‚ú®</h3>
            <p class="sub">Kia & Inezia share chocolate under sparkly skies. A gift appears‚Ä¶</p>
            <div class="gift">
              <div class="box" id="giftBox"><span class="ribbon"></span></div>
              <p id="giftMsg" class="sub">Click the gift to open</p>
            </div>
            <div id="wish" class="panel" style="display:none; margin-top:12px">
              <h3 class="title">Happy Birthday, Inezia üíô</h3>
              <p class="sub">You‚Äôre the sweetest human‚Äîsharp, funny, and full of light. May your year be cozy, loved, and always stocked with chocolate. ‚Äî Kia</p>
              <div class="cta"><button id="playAgain">Play Again</button></div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div id="popup" class="popup" role="dialog" aria-modal="true" aria-labelledby="popupTitle" aria-describedby="popupMsg">
    <div class="popup-backdrop"></div>
    <div class="panel popup-card">
      <h3 class="title" id="popupTitle"></h3>
      <p class="sub" id="popupMsg"></p>
      <div class="cta" style="justify-content:center"><button id="popupBtn">Continue</button></div>
    </div>
  </div>

<script>
const state = {
  level: 1,
  chocolates: 0,
  ttt:{ board:Array(9).fill(null), player:'X', bot:'O', score:{me:0,bot:0}, rounds:0, matchOver:false },
  sudoku:{},
  boss:{ paid:false, blocks:0 }
};

const bgm = document.getElementById('bgm');
let musicStarted = false;
function playSong(){
  if(musicStarted) return;
  bgm.volume = 0.6;
  const playPromise = bgm.play();
  if(playPromise && typeof playPromise.then === 'function'){
    playPromise.then(()=>{ musicStarted = true; }).catch(()=>{});
  } else {
    musicStarted = true;
  }
}
window.addEventListener('load',()=>{ setTimeout(()=> playSong(), 150); });
document.addEventListener('pointerdown', playSong, { once:true });

// UI helpers
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
function show(id){ $$('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); updateHUD(); }
function updateHUD(){
  const label = typeof state.level === 'number' ? `Level ${state.level}` : state.level;
  $('#lvl').textContent = label;
  $('#choc').textContent = state.chocolates;
}

// Popup helpers
const popupEl = $('#popup');
const popupBtn = $('#popupBtn');
function showPopup({ title, message, buttonText = 'Continue', onConfirm }){
  $('#popupTitle').textContent = title;
  $('#popupMsg').textContent = message;
  popupBtn.textContent = buttonText;
  popupBtn.onclick = () => {
    hidePopup();
    if(typeof onConfirm === 'function'){ onConfirm(); }
  };
  popupEl.classList.add('active');
  document.body.classList.add('popup-open');
  setTimeout(()=> popupBtn.focus(), 60);
}
function hidePopup(){
  popupEl.classList.remove('active');
  document.body.classList.remove('popup-open');
}

// Intro
$('#start').addEventListener('click',()=>{ playSong(); state.level=1; updateHUD(); initTTT(); show('#screen-ttt'); });
$('#restart').addEventListener('click',()=>{ location.reload(); });

/******************** Level 1: TicTacToe ********************/ 
const yapLines = [
  "I‚Äôm not overthinking‚ÄîI‚Äôm just thinking twice.",
  "If I lose, it‚Äôs a growth mindset moment.",
  "Beep boop, strategic yap engaged.",
  "Your move looks delicious."
];
function sayYap(){ $('#yapLines').textContent = `‚Äú${yapLines[Math.floor(Math.random()*yapLines.length)]}‚Äù`; }

function initTTT(){
  state.ttt.board = Array(9).fill(null); state.ttt.player='X'; state.ttt.bot='O'; state.ttt.rounds=0; state.ttt.score={me:0,bot:0}; state.ttt.matchOver=false;
  const b = $('#tttBoard'); b.innerHTML='';
  for(let i=0;i<9;i++){
    const cell = document.createElement('button');
    cell.dataset.idx=i;
    cell.addEventListener('click', onTTTClick);
    b.appendChild(cell);
  }
  $('#tttMsg').textContent = 'Best of 3 ‚Äî you start as X';
  $('#tttReset').textContent = 'Reset Round';
  $('#tttReset').onclick = ()=> resetTTTRound();
  sayYap();
}
function resetTTTRound(){
  if(state.ttt.matchOver){ initTTT(); return; }
  state.ttt.board = Array(9).fill(null);
  $$('#tttBoard button').forEach(c=>{c.textContent=''; c.classList.remove('win'); c.disabled=false;});
  $('#tttMsg').textContent='New round!';
  sayYap();
}
function onTTTClick(e){
  const idx = +e.currentTarget.dataset.idx; if (state.ttt.board[idx]) return;
  move(idx, state.ttt.player); if (checkWin(state.ttt.player)) return endRound('me');
  if (isFull()) return endRound('draw');
  // simple bot: win > block > center > random
  const botIdx = tttBotMove(); move(botIdx, state.ttt.bot); if (checkWin(state.ttt.bot)) return endRound('bot');
  if (isFull()) return endRound('draw');
}
function move(idx, sym){ state.ttt.board[idx]=sym; const btn = $$('#tttBoard button')[idx]; btn.textContent=sym; btn.disabled=true; }
const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
function checkWin(sym){
  for(const w of wins){ if(w.every(i=>state.ttt.board[i]===sym)){ w.forEach(i=> $$('#tttBoard button')[i].classList.add('win')); return true;} }
  return false;
}
function isFull(){ return state.ttt.board.every(Boolean); }
function emptyIdx(){ return state.ttt.board.map((v,i)=>v?null:i).filter(v=>v!==null); }
function tttBotMove(){
  // try to win
  for(const i of emptyIdx()){ state.ttt.board[i]=state.ttt.bot; if(checkWin(state.ttt.bot)){ state.ttt.board[i]=null; return i;} state.ttt.board[i]=null; }
  // try to block
  for(const i of emptyIdx()){ state.ttt.board[i]=state.ttt.player; if(checkWin(state.ttt.player)){ state.ttt.board[i]=null; return i;} state.ttt.board[i]=null; }
  // center if free
  if(!state.ttt.board[4]) return 4;
  // otherwise random
  const free = emptyIdx(); return free[Math.floor(Math.random()*free.length)];
}
function endRound(result){
  state.ttt.rounds++;
  $$('#tttBoard button').forEach(b=> b.disabled=true);
  if(result==='me'){ state.ttt.score.me++; $('#tttMsg').textContent = `You win the round! ${state.ttt.score.me} - ${state.ttt.score.bot}`; }
  else if(result==='bot'){ state.ttt.score.bot++; $('#tttMsg').textContent = `Yapbot wins the round! ${state.ttt.score.me} - ${state.ttt.score.bot}`; }
  else { $('#tttMsg').textContent = `Draw. ${state.ttt.score.me} - ${state.ttt.score.bot}`; }
  // best of 3
  if(state.ttt.score.me===2 || state.ttt.score.bot===2 || state.ttt.rounds===3){
    state.ttt.matchOver = true;
    if(state.ttt.score.me>state.ttt.score.bot){
      state.chocolates += 5; updateHUD();
      $('#tttMsg').textContent = `Victory! +5 chocolates. Kia is setting up the next challenge‚Ä¶`;
      $('#tttReset').textContent = 'Play Again';
      showPopup({
        title: 'Level 1 Complete!',
        message: 'You outsmarted Yapbot and earned 5 chocolates. Ready for Kia‚Äôs brainy Sudoku challenge?',
        buttonText: 'Continue to Level 2',
        onConfirm: ()=>{ state.level=2; updateHUD(); initSudoku(); show('#screen-sudoku'); }
      });
    } else {
      $('#tttMsg').innerHTML = `Yapbot wins the match. <b>Press Reset Round to try again.</b>`;
      $('#tttReset').textContent = 'Try Again';
    }
  } else {
    // prepare next round
    setTimeout(()=> resetTTTRound(), 600);
  }
}

/******************** Level 2: Sudoku 4x4 ********************/ 
const presetPuzzles = [
  // 0 = empty
  [0,0,2,0,  0,0,0,1,  0,4,0,0,  3,0,0,0],
  [1,0,0,0,  0,3,0,4,  0,0,4,0,  0,2,0,1],
  [0,2,0,0,  0,0,3,0,  0,1,0,4,  0,0,0,0],
];
function initSudoku(){
  const grid = $('#sGrid'); grid.innerHTML='';
  state.sudoku.solution = gen4x4Solution();
  state.sudoku.puzzle = carvePuzzle(state.sudoku.solution);
  state.sudoku.cleared = false;
  for(let i=0;i<16;i++){
    const inp = document.createElement('input');
    if(state.sudoku.puzzle[i]!==0){ inp.value=state.sudoku.puzzle[i]; inp.disabled=true; inp.classList.add('block'); }
    inp.maxLength=1; inp.inputMode='numeric';
    inp.addEventListener('input',e=>{ e.target.value = e.target.value.replace(/[^1-4]/g,''); });
    grid.appendChild(inp);
  }
  $('#sMsg').textContent='';
  $('#checkSudoku').disabled=false;
  $('#newSudoku').disabled=false;
}

function gen4x4Solution(){
  // simple Latin square 1..4 shifted rows/cols
  const base=[1,2,3,4];
  const rows=[ base, rot(base,1), rot(base,2), rot(base,3) ];
  // shuffle rows and columns within 2x2 sub-blocks for variety
  const rnd = a=> a.sort(()=>Math.random()-0.5);
  let rorder = rnd([0,1,2,3]); let corder = rnd([0,1,2,3]);
  const sol=[]; for(let r=0;r<4;r++){ for(let c=0;c<4;c++){ sol.push(rows[rorder[r]][corder[c]]); } }
  return sol;
}
function rot(arr,n){ return arr.slice(n).concat(arr.slice(0,n)); }
function carvePuzzle(sol){
  // use a preset mask for nicer shapes, then remove a few more
  const base = presetPuzzles[Math.floor(Math.random()*presetPuzzles.length)].slice();
  const out = base.map((v,i)=> v? sol[i]: 0);
  // remove 3 random cells to ensure some blanks
  const idx=[...Array(16).keys()]; idx.sort(()=>Math.random()-0.5).slice(0,3).forEach(i=> out[i]=0);
  return out;
}

$('#newSudoku').addEventListener('click', initSudoku);
$('#checkSudoku').addEventListener('click', ()=>{
  const vals=[...$('#sGrid').querySelectorAll('input')].map(inp=> +inp.value || 0);
  if(state.sudoku.cleared){ return; }
  const ok = isValid4x4(vals);
  if(!ok){ $('#sMsg').innerHTML = `<span class="err">Not quite right‚Äîcheck rows and columns.</span>`; return; }
  // compare to solution set (allow any valid solution; for simplicity check via constraints only)
  $('#sMsg').innerHTML = `<span class="ok">Solved! +10 chocolates</span>`;
  state.chocolates += 10; updateHUD();
  state.sudoku.cleared = true;
  $('#checkSudoku').disabled = true;
  $('#newSudoku').disabled = true;
  showPopup({
    title: 'Level 2 Clear!',
    message: 'Brilliant mind! Take your 10 chocolates and face the Manipulative Crocodile.',
    buttonText: 'Final Boss ‚Üí',
    onConfirm: ()=>{ state.level=3; updateHUD(); initBoss(); show('#screen-boss'); }
  });
});

function isValid4x4(vals){
  // must be 1-4 no zeros
  if(vals.some(v=> v<1 || v>4)) return false;
  // rows
  for(let r=0;r<4;r++){
    const row = vals.slice(r*4,(r+1)*4);
    if(new Set(row).size!==4) return false;
  }
  // cols
  for(let c=0;c<4;c++){
    const col = [vals[c],vals[c+4],vals[c+8],vals[c+12]];
    if(new Set(col).size!==4) return false;
  }
  return true;
}

/******************** Level 3: Boss ********************/ 
const crocLines=[
  "If they cared, they‚Äôd read your mind.",
  "Sharing is losing. Keep it all.",
  "You‚Äôre overreacting‚Äîagain.",
  "You owe me your silence."
];
function initBoss(){
  state.boss.paid=false; state.boss.blocks=0; $('#block1').disabled=true; $('#block2').disabled=true; $('#block3').disabled=true;
  ['block1','block2','block3'].forEach(id=>{ $('#'+id).classList.remove('good'); });
  $('#payKia').disabled=false;
  $('#payKia').textContent = 'Pay Kia 10 üç´';
  nextCrocLine();
}
function nextCrocLine(){ $('#crocLine').textContent = `‚Äú${crocLines[Math.floor(Math.random()*crocLines.length)]}‚Äù`; }
$('#payKia').addEventListener('click',()=>{
  if(state.boss.paid) return;
  if(state.chocolates<10){ alert('Not enough chocolates. You need 10.'); return; }
  state.chocolates-=10; updateHUD(); state.boss.paid=true;
  $('#block1').disabled=false; $('#block2').disabled=false; $('#block3').disabled=false;
  $('#payKia').disabled=true;
  $('#payKia').textContent = 'Kia is with you ‚ú®';
  $('#crocLine').textContent = 'Kia: ‚ÄúI‚Äôm here. Let‚Äôs block those lies‚Äîtap the three blocks!‚Äù';
});
['block1','block2','block3'].forEach(id=>{
  $("#"+id).addEventListener('click',()=>{
    if(!state.boss.paid) return;
    const el = $("#"+id);
    if(el.classList.contains('good')) return;
    el.classList.add('good');
    state.boss.blocks++;
    if(state.boss.blocks>=3){
      state.level = 'Victory ‚ú®';
      updateHUD();
      show('#screen-end');
      return;
    }
    nextCrocLine();
  });
});

/******************** Ending ********************/ 
$('#giftBox').addEventListener('click',()=>{
  $('#giftMsg').textContent = 'üíå';
  $('#wish').style.display='block';
});
$('#playAgain').addEventListener('click',()=> location.reload());
</script>
</body>
</html>
